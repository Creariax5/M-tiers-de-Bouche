// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Recipe {
  id          String   @id @default(uuid())
  userId      String   // Propri√©taire de la recette
  name        String
  description String?
  category    String?  // "Viennoiserie", "P√¢tisserie", "Boulangerie", etc.
  servings    Int      @default(1) // Nombre de portions
  
  // Relations
  ingredients RecipeIngredient[] // Ingr√©dients utilis√©s dans cette recette
  usedInRecipes RecipeIngredient[] @relation("SubRecipe") // Recettes qui utilisent celle-ci
  
  // M√©tadonn√©es
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([category])
  @@map("recipes")
}

model Ingredient {
  id          String   @id @default(uuid())
  userId      String   // Propri√©taire de l'ingr√©dient (custom) ou "system" pour base commune
  name        String
  unit        String   @default("g") // g, kg, L, ml, pi√®ce
  pricePerUnit Float   @default(0) // Prix par unit√©
  
  // Valeurs nutritionnelles pour 100g/100ml (CONFORMIT√â INCO)
  calories       Float? // kcal (sera converti en kJ automatiquement)
  proteins       Float? // g - Prot√©ines
  carbs          Float? // g - Glucides totaux
  sugars         Float? // g - dont sucres (OBLIGATOIRE INCO)
  fats           Float? // g - Mati√®res grasses totales
  saturatedFats  Float? // g - dont acides gras satur√©s (OBLIGATOIRE INCO)
  salt           Float? // g - Sel (arrondi 2 d√©cimales)
  
  // Valeurs nutritionnelles facultatives
  fiber          Float? // g - Fibres alimentaires
  
  // Allerg√®nes (14 ADO - Allerg√®nes √† D√©claration Obligatoire)
  allergens      String?  // CSV: "gluten,lait,oeufs"
  allergenTraces String?  // Traces possibles: "fruits-a-coque,arachides"
  
  // Relations
  recipes     RecipeIngredient[]
  
  // M√©tadonn√©es
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([name])
  @@map("ingredients")
}

model RecipeIngredient {
  id           String   @id @default(uuid())
  recipeId     String
  ingredientId String?  // üÜï Optionnel (exclusif avec subRecipeId)
  subRecipeId  String?  // üÜï Sous-recette utilis√©e comme ingr√©dient
  quantity     Float    // Quantit√© utilis√©e
  unit         String   // Unit√© (g, kg, L, ml, pi√®ce)
  lossPercent  Float    @default(0) // Pourcentage de perte (0-100)
  
  // Relations
  recipe       Recipe      @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredient   Ingredient? @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  subRecipe    Recipe?     @relation("SubRecipe", fields: [subRecipeId], references: [id], onDelete: Cascade)
  
  // M√©tadonn√©es
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([recipeId])
  @@index([ingredientId])
  @@index([subRecipeId])
  @@map("recipe_ingredients")
}
