// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Recipe {
  id          String   @id @default(uuid())
  userId      String   // Propri√©taire de la recette
  name        String
  description String?
  category    String?  // "Viennoiserie", "P√¢tisserie", "Boulangerie", etc.
  servings    Int      @default(1) // Nombre de portions
  imageUrl    String?  // URL de l'image (MinIO S3)
  
  // Relations
  ingredients RecipeIngredient[] // Ingr√©dients utilis√©s dans cette recette
  usedInRecipes RecipeIngredient[] @relation("SubRecipe") // Recettes qui utilisent celle-ci
  
  // M√©tadonn√©es
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([category])
  @@map("recipes")
}

// Base d'ingr√©dients Ciqual (3000+ aliments)
model BaseIngredient {
  id          String   @id @default(uuid())
  name        String
  category    IngredientCategory
  
  // Valeurs nutritionnelles pour 100g (CONFORMIT√â INCO)
  calories    Float   // kcal
  protein     Float   // g - Prot√©ines
  carbs       Float   // g - Glucides totaux
  fat         Float   // g - Mati√®res grasses
  salt        Float   // g - Sel (arrondi 2 d√©cimales OBLIGATOIRE)
  fiber       Float?  // g - Fibres (optionnel)
  sugar       Float?  // g - Sucres (optionnel)
  
  // Allerg√®nes (14 ADO - Allerg√®nes √† D√©claration Obligatoire)
  allergens   String[] // Array: ["gluten", "lait", "oeufs"]
  
  // Source Ciqual
  ciqualCode  String?  @unique
  
  // Relations
  recipes     RecipeIngredient[]
  
  @@index([name])
  @@map("base_ingredients")
}

// Cat√©gories d'ingr√©dients
enum IngredientCategory {
  FARINES
  SUCRES
  MATIERES_GRASSES
  PRODUITS_LAITIERS
  OEUFS
  CHOCOLAT_CACAO
  FRUITS
  FRUITS_SECS
  EPICES
  LEVURES
  ADDITIFS
  AUTRE
}

// Ingr√©dients personnalis√©s par utilisateur
model CustomIngredient {
  id          String   @id @default(uuid())
  userId      String
  name        String
  category    IngredientCategory
  
  // Prix et fournisseur
  price       Float    // Prix par unit√©
  priceUnit   Unit
  supplier    String?
  
  // Tra√ßabilit√©
  lotNumber   String?
  expiryDate  DateTime?
  
  // Valeurs nutritionnelles pour 100g (CONFORMIT√â INCO - optionnel car perso)
  calories    Float?
  protein     Float?
  carbs       Float?
  fat         Float?
  salt        Float?
  
  // Allerg√®nes
  allergens   String[] @default([])
  
  // Relations
  recipes     RecipeIngredient[]
  
  // M√©tadonn√©es
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([name])
  @@map("custom_ingredients")
}

// Unit√©s de mesure
enum Unit {
  G
  KG
  L
  ML
  PIECE
}

model RecipeIngredient {
  id           String   @id @default(uuid())
  recipeId     String
  
  // üîÑ Exclusif : soit baseIngredient, soit customIngredient, soit subRecipe
  baseIngredientId   String?
  customIngredientId String?
  subRecipeId        String?
  
  quantity     Float    // Quantit√© utilis√©e
  unit         Unit     // Unit√© (G, KG, L, ML, PIECE)
  lossPercent  Float    @default(0) // Pourcentage de perte (0-100)
  
  // Relations
  recipe          Recipe            @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  baseIngredient  BaseIngredient?   @relation(fields: [baseIngredientId], references: [id], onDelete: Cascade)
  customIngredient CustomIngredient? @relation(fields: [customIngredientId], references: [id], onDelete: Cascade)
  subRecipe       Recipe?           @relation("SubRecipe", fields: [subRecipeId], references: [id], onDelete: Cascade)
  
  // M√©tadonn√©es
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([recipeId])
  @@index([baseIngredientId])
  @@index([customIngredientId])
  @@index([subRecipeId])
  @@map("recipe_ingredients")
}
